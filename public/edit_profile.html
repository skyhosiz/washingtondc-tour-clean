<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Profile | Washington D.C.</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Kanit',sans-serif;
  background:radial-gradient(circle,#1c1a33,#0b0814);
  color:#fff;min-height:100vh;
}
/* Navbar */
.navbar{
  position:fixed;top:0;left:0;width:100%;height:70px;
  background:rgba(0,0,0,.7);backdrop-filter:blur(8px);
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 24px;z-index:99;
}
.nav-btn{
  background:#d9534f;color:#fff;padding:8px 14px;
  border:none;border-radius:8px;font-size:14px;font-weight:600;
  cursor:pointer;transition:.25s;
}
.nav-btn:hover{transform:translateY(-2px);filter:brightness(1.1)}
.brand{font-size:22px;font-weight:700}
/* Container + Card */
.container{max-width:450px;margin:auto;padding-top:120px;text-align:center}
.card{
  background:rgba(255,255,255,.08);
  padding:28px;border-radius:18px;
  box-shadow:0 0 20px rgba(255,150,60,.45);
}
/* Profile Image */
.profile-img-wrapper{position:relative;width:120px;height:120px;margin:8px auto;cursor:pointer}
.profile-img{
  width:100%;height:100%;border-radius:50%;
  object-fit:cover;border:3px solid #ff9a3c;transition:.25s;
}
.profile-img-wrapper:hover .profile-img{transform:scale(1.05)}
input{width:100%;padding:12px;margin:10px 0;border-radius:10px;border:none;font-size:16px}
.btn-save,.back-btn{
  width:100%;padding:12px;margin-top:12px;border:none;
  border-radius:10px;font-size:17px;font-weight:700;cursor:pointer;transition:.25s;
}
.btn-save{background:#ff952e;color:#000}
.btn-save:hover{filter:brightness(1.1);transform:translateY(-2px)}
.back-btn{background:#666;color:#fff}
.back-btn:hover{filter:brightness(1.1);transform:translateY(-2px)}
</style>
</head>

<body>
<div class="navbar">
  <div class="brand">Edit Profile</div>
  <button class="nav-btn" onclick="logout()">LOGOUT</button>
</div>

<div class="container">
<div class="card">
  <label for="imgUpload" class="profile-img-wrapper">
    <img id="profileImg" class="profile-img" src="pic/default.png" alt="profile"/>
  </label>
  <input type="file" id="imgUpload" accept="image/*" hidden>

  <input type="text" id="nameInput" placeholder="Loading...">

  <button class="btn-save" onclick="saveEdit()">✅ บันทึกข้อมูล</button>
  <button class="back-btn" onclick="location.href='profile.html'">⬅ ย้อนกลับ</button>
</div>
</div>

<script>
const API_BASE = location.hostname === "localhost"
  ? "http://localhost:3000"
  : "https://washingtondc-tour-clean.onrender.com";

/* ✅ Guard Login */
document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("token");
  if (!token) return location.href="login.html";
  loadCached();
  loadUser();
});

/* ✅ Load Cached UI */
function loadCached(){
  const u = JSON.parse(localStorage.getItem("user")||"null");
  if(!u) return;
  profileImg.src = u.profileImg || "pic/default.png";
  nameInput.value = u.username || "";
}

/* ✅ Load from Server */
async function loadUser(){
  try{
    const r = await fetch(`${API_BASE}/api/auth/profile`, {
      headers:{Authorization:"Bearer "+localStorage.getItem("token")}
    });
    const data = await r.json();
    if(data.status!=="success") return;
    localStorage.setItem("user", JSON.stringify(data.user));
    loadCached();
  }catch(e){console.log(e)}
}

/* ✅ Choose Image Preview */
imgUpload.addEventListener("change",()=>{
  const f = imgUpload.files[0];
  if(f) profileImg.src = URL.createObjectURL(f);
})

/* ✅ Save Edited Data */
async function saveEdit(){
  const fd = new FormData();
  if(nameInput.value.trim()) fd.append("username", nameInput.value.trim());
  if(imgUpload.files[0]) fd.append("profileImg", imgUpload.files[0]);

  try{
    const r = await fetch(`${API_BASE}/api/auth/profile`, {
      method:"PUT",
      headers:{Authorization:"Bearer "+localStorage.getItem("token")},
      body:fd
    });
    const data = await r.json();
    if(data.status==="success"){
      localStorage.setItem("user",JSON.stringify(data.user));
      alert("✅ อัปเดตสำเร็จ!");
      location.href="profile.html";
    }else alert("⚠ มีบางอย่างผิดพลาด");
  }catch(e){alert("⚠ เกิดข้อผิดพลาด");}
}

/* ✅ Logout */
function logout(){
  localStorage.clear();
  location.href="login.html";
}
</script>

</body>
</html>
