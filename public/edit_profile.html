<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Profile</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;}

body{
  font-family:'Kanit',sans-serif;
  background:radial-gradient(circle,#1c1a33,#0b0814);
  color:white;
  min-height:100vh;
}

.navbar{
  position:fixed; top:0; left:0;
  width:100%; height:70px;
  background:rgba(0,0,0,.75);
  padding:14px 24px;
  display:flex; justify-content:space-between; align-items:center;
  z-index:999; backdrop-filter:blur(8px);
}
.brand{
  font-size:22px; font-weight:700;
  background:linear-gradient(90deg,#ffd089,#ff8a25);
  -webkit-background-clip:text; color:transparent;
}
.nav-right{display:flex;align-items:center;gap:12px;}
.nav-btn{
  background:#ffb55b;color:#222;
  padding:8px 14px; border:none; border-radius:8px;
  cursor:pointer; font-size:14px; font-weight:600;
}
.nav-btn:hover{filter:brightness(1.12);transform:translateY(-1px);}

.container{
  max-width:450px;
  margin:auto;
  padding-top:120px;
  text-align:center;
}

.card{
  background:rgba(255,255,255,0.08);
  padding:30px;
  border-radius:18px;
  box-shadow:0 0 20px rgba(255,150,60,0.45);
}

.profile-img-wrapper {
  position: relative;
  width: 120px;
  height: 120px;
  margin: auto;
  margin-bottom: 16px;
  cursor: pointer;
}

.profile-img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #ff9a3c;
  transition: .25s;
}

.profile-img-wrapper:hover .profile-img {
  transform: scale(1.05);
  filter: brightness(1.1);
}

.edit-icon {
  position: absolute;
  bottom: -5px;
  right: -5px;
  background: #ff952e;
  color: #000;
  font-size: 12px;
  font-weight: 700;
  padding: 6px 12px;
  border-radius: 10px;
  opacity: 0;
  pointer-events: none;
  transition: .25s;
}

.profile-img-wrapper:hover .edit-icon {
  opacity: 1;
  transform: translateY(-3px);
}

input{
  width:100%; padding:11px;
  margin:8px 0; border-radius:10px;
  border:none; font-size:16px; outline:none;
}

.btn-save{
  width:100%; padding:13px;
  background:#ff952e; color:#000;
  font-weight:700; border:none;
  border-radius:10px; cursor:pointer;
  margin-top:16px; font-size:18px;
}
.btn-save:hover{transform:translateY(-3px);filter:brightness(1.12);}

.back-btn{
  width:100%; margin-top:10px;
  background:#666; color:#fff;
  padding:11px; border-radius:10px;
  cursor:pointer; font-weight:600;
}
.back-btn:hover{transform:translateY(-3px);filter:brightness(1.1);}
</style>
</head>

<body>


<div class="navbar">
  <div class="brand">Edit Profile</div>
  <div class="nav-right">
    <button class="nav-btn" onclick="location.href='profile.html'">PROFILE</button>
    <button class="nav-btn" style="background:#d9534f;color:#fff;" onclick="logout()">LOGOUT</button>
  </div>
</div>

<div class="container">
  <div class="card">

    <div class="profile-img-wrapper">
      <label for="imgUpload">
        <img id="profileImg" class="profile-img" src="pic/default.png">
        <span class="edit-icon">üì∑ Edit</span>
      </label>
    </div>
    <input type="file" id="imgUpload" accept="image/*" hidden>

    <input type="text" id="nameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà">
    <input type="email" id="emailInput" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡∏°‡πà">
    <input type="password" id="passInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">

    <button class="btn-save" onclick="saveProfile()">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="back-btn" onclick="location.href='profile.html'">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>

  </div>
</div>

<script src="js/auth.js"></script>

<script>
async function loadUserData(){
  const res = await fetch("/profile", {
    headers:{ Authorization:"Bearer "+localStorage.getItem("token") }
  });
  const data = await res.json();

  if(data.status!=="success") return logout();

  nameInput.placeholder = data.user.username;
  emailInput.placeholder = data.user.email;
  profileImg.src =
    data.user.profileImg && data.user.profileImg !== ""
    ? data.user.profileImg
    : "pic/default.png";
}
loadUserData();


imgUpload.addEventListener("change", async()=>{

  const file = imgUpload.files[0];
  if(!file) return;

  const formData = new FormData();
  formData.append("image", file);

  const res = await fetch("/uploadProfilePic",{
    method:"POST",
    headers:{ Authorization:"Bearer "+localStorage.getItem("token") },
    body:formData
  });

  const data = await res.json();

  if(data.status==="success"){
    profileImg.src = data.profileImg;

    const refresh = await fetch("/profile", {
      headers:{ Authorization:"Bearer "+localStorage.getItem("token") }
    });
    const newProfile = await refresh.json();
    localStorage.setItem("user", JSON.stringify(newProfile.user));

    alert("‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß!");
  }
});


async function saveProfile(){
  const body = {};
  if(nameInput.value.trim()) body.username = nameInput.value;
  if(emailInput.value.trim()) body.email = emailInput.value;
  if(passInput.value.trim()) body.password = passInput.value;

  const res = await fetch("/updateProfile",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization: "Bearer "+localStorage.getItem("token")
    },
    body:JSON.stringify(body)
  });

  const r = await res.json();
  if(r.status==="success"){

    const refresh = await fetch("/profile",{
      headers:{Authorization:"Bearer "+localStorage.getItem("token")}
    });
    const updated = await refresh.json();
    localStorage.setItem("user", JSON.stringify(updated.user));

    alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    location.href = "profile.html";
  }
}
</script>

</body>
</html>
