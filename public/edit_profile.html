<!DOCTYPE html>

<html lang="th">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Edit Profile | Washington D.C.</title>

    <script src="js/auth.js"></script>

    <script src="js/nav.js" defer></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Kanit", sans-serif;

        background: radial-gradient(circle, #1c1a33, #0b0814);

        color: white;
        min-height: 100vh;
      }

      .container {
        max-width: 450px;
        margin: auto;

        padding-top: 100px;

        padding-bottom: 40px;

        text-align: center;
      }

      .card {
        background: rgba(255, 255, 255, 0.08);

        padding: 30px;
        border-radius: 18px;

        box-shadow: 0 0 20px rgba(255, 150, 60, 0.45);
      }

      .profile-img-wrapper {
        position: relative;

        width: 120px;
        height: 120px;

        margin: auto 0 16px;
        cursor: pointer;
      }

      .profile-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;

        object-fit: cover;
        border: 3px solid #ff9a3c;

        transition: 0.25s;
      }

      .profile-img-wrapper:hover .profile-img {
        transform: scale(1.05);
        filter: brightness(1.1);
      }

      .edit-icon {
        position: absolute;
        bottom: -5px;
        right: -5px;

        background: #ff952e;
        color: #000;
        font-size: 12px;

        padding: 6px 12px;
        border-radius: 10px;

        opacity: 0;
        pointer-events: none;
        transition: 0.25s;
      }

      .profile-img-wrapper:hover .edit-icon {
        opacity: 1;
        transform: translateY(-3px);
      }

      input {
        width: 100%;
        padding: 12px;
        margin: 8px 0;

        border-radius: 10px;
        border: none;

        font-size: 16px;
        outline: none;
      }

      .btn-save {
        width: 100%;
        padding: 13px;
        margin-top: 16px;

        background: #ff952e;
        color: #000;

        font-weight: 700;
        border: none;
        border-radius: 10px;

        font-size: 18px;
        cursor: pointer;
        transition: 0.25s;
      }

      .btn-save:hover {
        transform: translateY(-3px);
        filter: brightness(1.1);
      }

      .back-btn {
        width: 100%;
        padding: 11px;
        margin-top: 10px;

        background: #666;
        color: #fff;
        border: none;

        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;

        transition: 0.25s;
      }

      .back-btn:hover {
        transform: translateY(-3px);
        filter: brightness(1.1);
      }
    </style>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-VGBZS316J9"
    ></script>

    <script>
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }

      gtag("js", new Date());

      gtag("config", "G-VGBZS316J9");
    </script>
  </head>

  <body>
    <div class="container">
      <div class="card">
        <label for="imgUpload" class="profile-img-wrapper">
          <img id="profileImg" class="profile-img" src="pic/default.png" />

          <span class="edit-icon">üì∑ Edit</span>
        </label>

        <input type="file" id="imgUpload" accept="image/*" hidden />

        <input type="text" id="nameInput" placeholder="Loading..." />

        <button class="btn-save" onclick="saveEdit()">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

        <button class="back-btn" onclick="location.href='profile.html'">
          ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
        </button>
      </div>
    </div>

    <script>
      const API_BASE =
        location.hostname === "localhost"
          ? "http://localhost:3000"
          : "https://washingtondc-tour-clean.onrender.com";

      document.addEventListener("DOMContentLoaded", () => {
        showCachedIfAny();

        loadUser();
      });

      function showCachedIfAny() {
        const user = JSON.parse(localStorage.getItem("user") || "null");

        if (!user) return;

        profileImg.src = user.profileImg || "pic/default.png";

        nameInput.placeholder = user.username;
      }

      async function loadUser() {
        try {
          const r = await fetch(`${API_BASE}/api/auth/profile`, {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });

          const data = await r.json();

          if (data.status !== "success") return;

          localStorage.setItem("user", JSON.stringify(data.user));

          showCachedIfAny();
        } catch (err) {
          console.error(err);
        }
      }

      imgUpload.addEventListener("change", () => {
        const file = imgUpload.files[0];

        if (file) profileImg.src = URL.createObjectURL(file);
      });

      async function saveEdit() {
        const fd = new FormData();

        if (nameInput.value.trim())
          fd.append("username", nameInput.value.trim());

        if (imgUpload.files[0]) fd.append("profileImg", imgUpload.files[0]);

        try {
          const res = await fetch(`${API_BASE}/api/auth/profile`, {
            method: "PUT",

            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },

            body: fd,
          });

          const data = await res.json();

          if (data.status === "success") {
            gtag("event", "profile_update", {
              event_category: "User",
              event_label: "Profile Saved",
            });

            localStorage.setItem("user", JSON.stringify(data.user));

            alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

            location.href = "profile.html";
          } else {
            alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
          }
        } catch (err) {
          alert("‚ö† ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        }
      }
    </script>
  </body>
</html>
