<!DOCTYPE html>
<html lang="th">
<head>

<!-- ✅ Google Analytics: WashingtonDC-Tour -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VGBZS316J9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-VGBZS316J9');
</script>


<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Your Profile | Washington D.C.</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet" />
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Kanit',sans-serif;
  background:radial-gradient(circle,#1c1a33,#0b0814);
  color:#fff; min-height:100vh;
}
/* Navbar */
.navbar{
  position:fixed; top:0; left:0; width:100%; height:70px;
  padding:14px 24px; background:rgba(0,0,0,.75);
  display:flex; justify-content:space-between; align-items:center;
  backdrop-filter:blur(8px); z-index:99;
}
.brand{
  font-size:22px; font-weight:700;
  background:linear-gradient(90deg,#ffd089,#ff8a25);
  -webkit-background-clip:text; color:transparent;
}
.nav-right{display:flex; align-items:center; gap:12px;}
.nav-btn{
  padding:8px 14px; border:none; border-radius:8px; cursor:pointer;
  font-size:14px; font-weight:700; transition:.25s;
}
.btn-profile{background:#ffb55b; color:#222;}
.btn-logout{background:#d9534f; color:#fff;}
.nav-btn:hover{filter:brightness(1.12); transform:translateY(-2px);}

/* Card */
.container{
  display:flex; justify-content:center; align-items:center;
  min-height:100vh; padding-top:70px;
}
.card{
  width:350px; background:rgba(255,255,255,.08);
  backdrop-filter:blur(10px); padding:35px; border-radius:20px; text-align:center;
  box-shadow:0 0 22px rgba(255,150,60,.4); transition:.25s;
}
.profile-img{
  width:120px; height:120px; border-radius:50%;
  border:3px solid #ff952e; object-fit:cover; margin:0 auto 15px;
}
h2{
  font-size:26px; background:linear-gradient(90deg,#ffd785,#ff952e);
  -webkit-background-clip:text; color:transparent;
}
.user-email{font-size:17px; opacity:.9; margin-bottom:25px;}
.btn{
  width:100%; padding:13px; margin:10px 0; border:none; border-radius:10px;
  font-size:17px; cursor:pointer; font-weight:600; transition:.25s;
}
.edit-btn{background:#ff952e; color:#000;}
.logout2-btn{background:#d43f3f; color:#fff;}
.back-btn{background:#777;}
.btn:hover{filter:brightness(1.12); transform:translateY(-3px);}
</style>
</head>

<body>

<div class="navbar">
  <div class="brand">Washington D.C.</div>
  <div class="nav-right">
    <button class="nav-btn btn-profile" onclick="location.href='profile.html'">PROFILE</button>
    <button class="nav-btn btn-logout" onclick="logout()">LOGOUT</button>
  </div>
</div>

<div class="container">
  <div class="card">
    <img id="profileImg" class="profile-img" src="pic/default.png" alt="profile" />
    <h2 id="profileName">Loading…</h2>
    <div class="user-email" id="profileEmail">Loading…</div>

    <button class="btn edit-btn" onclick="location.href='edit_profile.html'">แก้ไขข้อมูล</button>
    <button class="btn logout2-btn" onclick="logout()">LOGOUT</button>
    <button class="btn back-btn" onclick="location.href='index.html'">← ย้อนกลับ</button>
  </div>
</div>

<script>
const API_BASE = (location.hostname === "localhost")
  ? "http://localhost:3000"
  : "https://washingtondc-tour-clean.onrender.com";

// ✅ Guard: ตรวจ token หลัง DOM โหลด
document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("token");
  if (!token) return location.href = "login.html";
  showCachedIfAny();
  fetchProfile();
});

// ✅ แสดงจากแคชก่อนเพื่อเร็วขึ้น
function showCachedIfAny(){
  const cached = JSON.parse(localStorage.getItem("user") || "null");
  if (cached) showProfile(cached);
}

// ✅ ดึงสดจากเซิร์ฟเวอร์ + เอฟเฟกต์โหลด
async function fetchProfile(){
  const card = document.querySelector(".card");
  card.style.opacity = "0.35";

  const token = localStorage.getItem("token");
  try{
    const res = await fetch(`${API_BASE}/api/auth/profile`, {
      headers: { "Authorization": "Bearer " + token }
    });

    if (res.status === 401 || res.status === 403) {
      return location.href = "login.html";
    }

    const data = await res.json().catch(() => null);
    if (data && data.status === "success" && data.user){
      localStorage.setItem("user", JSON.stringify(data.user));
      showProfile(data.user);
    } else {
      console.warn("⚠️ โปรไฟล์สดโหลดไม่สำเร็จ ใช้ข้อมูลแคชชั่วคราว");
    }
  } catch (err){
    console.error("Fetch profile failed:", err);
  } finally {
    card.style.opacity = "1";
  }
}

// ✅ อัปเดต UI
function showProfile(u){
  const img = document.getElementById("profileImg");
  document.getElementById("profileName").textContent = u.username || "-";
  document.getElementById("profileEmail").textContent = u.email || "-";
  img.src = u.profileImg || "pic/default.png";
  img.onerror = () => { img.src = "pic/default.png"; };
}

// ✅ ออกจากระบบ
function logout(){
  localStorage.removeItem("token");
  localStorage.removeItem("user");
  location.href = "login.html";
}
</script>

</body>
</html>
